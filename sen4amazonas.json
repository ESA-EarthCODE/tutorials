{"version":2,"kind":"Notebook","sha256":"a9be5e99836de376920435f49bb1d8382ed5f516bd607212f84f9342a0f485f3","slug":"sen4amazonas","location":"/PRR/sen4amazonas.ipynb","dependencies":[],"frontmatter":{"title":"Sen4Amazonas: Time-Series Forest Loss Zarr Cube","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"pangeo","language":"python"},"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"MIT","url":"https://opensource.org/licenses/MIT","name":"MIT License","free":true,"osi":true}},"github":"https://github.com/ESA-EarthCODE/tutorials","subject":"EarthCODE Tutorials","numbering":{"title":{"offset":1}},"source_url":"https://github.com/ESA-EarthCODE/tutorials/blob/main/PRR/sen4amazonas.ipynb","edit_url":"https://github.com/ESA-EarthCODE/tutorials/edit/main/PRR/sen4amazonas.ipynb","exports":[{"format":"ipynb","filename":"sen4amazonas.ipynb","url":"/tutorials/build/sen4amazonas-6eda2d20d2427d65286e745429b2c0b0.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Goal","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"JGX4B3BRZH"}],"key":"Zbd8GNovSg"},{"type":"text","value":": Produce a time-indexed Zarr data cube of forest-loss masks for the Amazonas region to enable scalable analysis and visualization. This example is based on the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"YgIkcHo9vE"},{"type":"link","url":"https://sen4ama.gisat.cz/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Sentinel for amazonas project","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zHMsJna5UP"}],"urlSource":"https://sen4ama.gisat.cz/","key":"DnG1ydNHhW"},{"type":"text","value":" project.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VK5iwLfmTf"}],"key":"mFzowGLMpa"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Classes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"kgGLfuFFFu"}],"key":"VBU2vl2A6w"},{"type":"text","value":":","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"kQXTpbk1CH"}],"key":"ui4lGA0p7V"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"1","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"OubxnmrZP6"},{"type":"text","value":" — forest loss","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"zIWGK5OZ7B"}],"key":"agPQa24uSI"}],"key":"zaQCeF75Id"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"0","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"tgE8gXciiF"},{"type":"text","value":" — no data / background (treated as missing)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"uhoN8B16DC"}],"key":"QHrLyyfjSN"}],"key":"DOgjg62N0p"}],"key":"EJxbNm3c0j"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Study area and grid","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"z2UPfaHz5A"}],"key":"kB6vbftlFe"},{"type":"text","value":":","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"sWxvH7Bhch"}],"key":"IBjRoqZSQV"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":10,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"CRS: ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"ZIRJO3rxJz"},{"type":"inlineCode","value":"EPSG:4326","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"kjuQ3cK4tH"}],"key":"qhZTXluomV"}],"key":"jAqujS2kG2"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Bounds: ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"uVtl7nEKD0"},{"type":"inlineCode","value":"-79.1997438, -17.27354892, -44.91217178, 9.0467434","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"N9XquQfpBF"}],"key":"tkmvxktdSk"}],"key":"bdZYsnedZn"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Resolution: ","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"FVpioMPBqK"},{"type":"inlineCode","value":"0.00017966","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"rLJc3eTfHs"},{"type":"text","value":" degrees (see ","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"rwXOlIAVoG"},{"type":"inlineCode","value":"gdalwarp","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"M9NmKrTtnC"},{"type":"text","value":" step)","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"sGaXd6RlGY"}],"key":"HfPGSWb3B7"}],"key":"PCntQmprPN"}],"key":"qFJZxXvp91"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"strong","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Workflow overview","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"I3VgAROTFI"}],"key":"udofMmTh2f"},{"type":"text","value":":","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"liASmC58EQ"}],"key":"Rv2lYy1UTY"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":15,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Convert each GeoTIFF mosaic to per-date Zarr with ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"ruuMTnfPqU"},{"type":"inlineCode","value":"gdalwarp","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"KJlivY6n3B"},{"type":"text","value":".","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"SjGc6orcVU"}],"key":"J51spFtUU8"}],"key":"dqjJ8m7wlr"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Build a sorted list of Zarr stores and timestamps.","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"Y30kSVTERA"}],"key":"msVjliuOSH"}],"key":"w35GCq38tj"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Initialize an empty target cube (","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"M4acOzPVPw"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"VsrEqcke53"},{"type":"text","value":") with the full time axis.","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"QDeXT4dL4M"}],"key":"x1IfdHOL8R"}],"key":"mcBBMy62DS"},{"type":"listItem","spread":true,"position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Append each slice into the cube using ","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"lDjCoa25Uj"},{"type":"inlineCode","value":"region","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"RpAZjXSN5H"},{"type":"text","value":" writes.","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"lzfo4zVcC0"}],"key":"v8i2QxsghZ"}],"key":"TSFXAF5O4W"},{"type":"listItem","spread":true,"position":{"start":{"line":19,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Tune chunking for performance and memory.","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"uYbjiO6Pqx"}],"key":"s46g3rBown"}],"key":"hyTqrH9dYr"}],"key":"H9vunYzKus"},{"type":"paragraph","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"strong","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"Requirements","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"UabbMQgstM"}],"key":"c7gX87vlfY"},{"type":"text","value":":","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"umZyHmh47L"}],"key":"UjnRohguyn"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":22,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"GDAL built with Zarr driver (","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"MOhAnYeXkN"},{"type":"inlineCode","value":"gdalwarp -of Zarr","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"gYbXz7Hsfj"},{"type":"text","value":")","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"KzBpFoeNxm"}],"key":"mNdMUeLBOW"}],"key":"v91wA0QqNf"},{"type":"listItem","spread":true,"position":{"start":{"line":23,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Python: ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"UOjgVBYSJT"},{"type":"inlineCode","value":"xarray","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"X6H4XTWR5e"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"MWONj8a6VD"},{"type":"inlineCode","value":"rioxarray","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"l1Wv8y2iwK"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"IkhLmVDyj6"},{"type":"inlineCode","value":"zarr","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"bnLvSmZANc"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"XD9kInjfRY"},{"type":"inlineCode","value":"dask[distributed]","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"IfuLTxagIj"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"FJvdkkd3f2"},{"type":"inlineCode","value":"numpy","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"ZxvUHsWD8B"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"v6NdUW9sOI"},{"type":"inlineCode","value":"pandas","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"buJKUSkHGU"},{"type":"text","value":", optionally ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"baAIsCDEmS"},{"type":"inlineCode","value":"hvplot.xarray","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"XtiJuNuWPq"},{"type":"text","value":" for quick QA","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"GdLdyK84uX"}],"key":"H0ZESbii1X"}],"key":"QMniUKHgEO"}],"key":"rIzWAfsqBN"},{"type":"paragraph","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"strong","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"Data layout","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"w28j546s7V"}],"key":"eAF58P6LQY"},{"type":"text","value":":","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"QzgXaoB6XF"}],"key":"AHiB0vX6mu"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":26,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Input: ","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"Rb8PFOoMur"},{"type":"inlineCode","value":"mosaics/*.tif","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"B1JESUR0o4"},{"type":"text","value":" (per-date masks)","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"F4G02BbGiy"}],"key":"qrrQNLGRPp"}],"key":"Od8FBqllAP"},{"type":"listItem","spread":true,"position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Intermediate: ","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"F6FNG80Opf"},{"type":"inlineCode","value":"mosaics/*.zarr","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"IvqhKZnKYq"},{"type":"text","value":" (per-date stores)","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"wvToeBmzTk"}],"key":"PNsXjxMtq4"}],"key":"p0FTaShTLB"},{"type":"listItem","spread":true,"position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Output: ","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"EIMUzwTgjJ"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"gCwUKlM2Bm"},{"type":"text","value":" (time-series cube)","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"G7i3ZAOuS5"}],"key":"Cu1Beda1Iy"}],"key":"NfMuLZDw1D"}],"key":"aqGWMJFPIg"}],"key":"xBrndE8D5d"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Discussion","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KePaRnAYOj"}],"identifier":"discussion","label":"Discussion","html_id":"discussion","implicit":true,"key":"MMcnrNm66A"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"When handling many temporal slices in Earth Observation, storing them as a single Zarr data cube is far superior to managing hundreds of COGs linked via a STAC collection because Zarr treats time as a first-class dimension within a unified array structure rather than as disconnected files. This enables efficient temporal queries and parallel access using chunked, compressed blocks that map directly to analysis patterns like pixel-wise time series or rolling statistics, all without the per-file latency, catalog management, and HTTP overhead that cripple COG-based stacks at scale.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tHdduJPWOi"}],"key":"Fo4eCSEl6H"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"To learn more read the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"q7hj3wi1E1"},{"type":"link","url":"https://esa-earthcode.github.io/documentation/Community%20and%20Best%20Practices/Data%20and%20Workflow%20Best%20Practices/Data/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"EarthCODE data best practices pages","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"IS9Qf5slr6"}],"urlSource":"https://esa-earthcode.github.io/documentation/Community%20and%20Best%20Practices/Data%20and%20Workflow%20Best%20Practices/Data/","key":"PlyVx9Y1ie"}],"key":"X4l7VNUvMi"}],"key":"sGTyAotigE"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"1) Convert GeoTIFFs to Zarr with GDAL","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EXfxDltOHu"}],"identifier":"id-1-convert-geotiffs-to-zarr-with-gdal","label":"1) Convert GeoTIFFs to Zarr with GDAL","html_id":"id-1-convert-geotiffs-to-zarr-with-gdal","implicit":true,"key":"kATc6aDaK5"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Use GDAL to warp each input GeoTIFF to ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"jYXtFYA8OF"},{"type":"inlineCode","value":"EPSG:4326","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kXX2SgrBYw"},{"type":"text","value":", clip to the Amazonas extent, set the target resolution, and write per-date Zarr stores. Adjust ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"b2TOEWxhxm"},{"type":"inlineCode","value":"IN_DIR","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"xJzbqcbct4"},{"type":"text","value":", ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"YWxAolrTuz"},{"type":"inlineCode","value":"OUT_DIR","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"B43jfK9lpB"},{"type":"text","value":", bounds (","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"L1FKjo6yTT"},{"type":"inlineCode","value":"-te","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QKDHbtBgdg"},{"type":"text","value":"), resolution (","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"HK3xvwSM8Q"},{"type":"inlineCode","value":"-tr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hd2NmlJ2zG"},{"type":"text","value":"), and compression to match your data and hardware.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"riCTV2WuYy"}],"key":"xdnAnHDQFi"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Tip: Confirm Zarr support with ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"eQITTyeI3H"},{"type":"inlineCode","value":"gdalinfo --formats | grep -i zarr","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"hjg9pgtcS9"},{"type":"text","value":".","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"en6duprPMi"}],"key":"SXyQ7TM3XU"}],"key":"sYeFmU4JWI"},{"type":"block","kind":"notebook-content","children":[{"type":"code","lang":"bash","value":"%%bash\n#!/usr/bin/env bash\nset -euo pipefail\n\nIN_DIR=\"mosaics\"\nOUT_DIR=\"mosaics\"\n\nfor tif in \"${IN_DIR}\"/*.tif; do\n  base=\"$(basename \"${tif}\" .tif)\"\n  out=\"${OUT_DIR}/${base}.zarr\"\n\n  echo \"Warping ${tif} -> ${out}\"\n  gdalwarp -overwrite \\\n    -t_srs EPSG:4326 \\\n    -te -79.1997438 -17.27354892 -44.91217178 9.0467434 \\\n    -tr 0.00017966 0.00017966 \\\n    -r near \\\n    -dstnodata 0 \\\n    \"${tif}\" \\\n    \"${out}\" \\\n    -of Zarr \\\n    -multi -wo NUM_THREADS=ALL_CPUS \\\n    -co COMPRESS=ZSTD -co ZSTD_LEVEL=3 -co BLOCKSIZE=512,512\n\ndone","position":{"start":{"line":1,"column":1},"end":{"line":27,"column":1}},"key":"zQvxAjil4T"}],"key":"ttoVJlm9NH"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2) Python setup and file discovery","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ry9331oPAD"}],"identifier":"id-2-python-setup-and-file-discovery","label":"2) Python setup and file discovery","html_id":"id-2-python-setup-and-file-discovery","implicit":true,"key":"h4jkbuRGhq"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Import libraries, set the input folder (","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"cWtaiRKSO6"},{"type":"inlineCode","value":"mosaics/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"W3j4shtcev"},{"type":"text","value":"), and collect per-date Zarr stores produced in step 1. Timestamps are parsed from filenames like ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fcoyOMCwYO"},{"type":"inlineCode","value":"prefix_YYYYMMDD.zarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VO3T5biSrv"},{"type":"text","value":". If your naming differs, adjust the parsing logic accordingly.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"a3wPy5eH3e"}],"key":"BkfPWU1d7F"}],"key":"pl4jtL3sEi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport rioxarray\nimport xarray as xr\nimport hvplot.xarray\nimport pandas as pd\nfrom pathlib import Path\n\nfolder = \"mosaics\"\nfiles = [os.path.join(folder, f) for f in os.listdir(folder) if f.endswith(\".zarr\")]\n# print(files)\n\ntimestamps = [\n    pd.to_datetime(os.path.splitext(Path(f).name)[0].split(\"_\")[1]) for f in files\n]\n# timestamps","key":"H8bkFur0FH"},{"type":"output","id":"_ksmq2AouXEknS8_9jOo2","data":[],"key":"Cy5kjnf1JN"}],"key":"d05RjvEWJC"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Sort files by timestamp","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FFXIaNLkv2"}],"identifier":"sort-files-by-timestamp","label":"Sort files by timestamp","html_id":"sort-files-by-timestamp","implicit":true,"key":"OEaq6CWhv5"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Ensure files and timestamps are aligned chronologically for consistent time indexing.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"wdNXQPv1iM"}],"key":"Ztd0gZG9t5"}],"key":"zCmKnozdDj"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\nii = np.argsort(timestamps)\ntimestamps = np.array(timestamps)[ii]\nfiles = np.array(files)[ii]\n# files","key":"Vb3viddo8w"},{"type":"output","id":"1_3VNZGiV9-uc769_aSIk","data":[],"key":"dVCIMUDiNr"}],"key":"wSvGyn3jIe"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Optional: Start a Dask client","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cnJaG8fy8Y"}],"identifier":"optional-start-a-dask-client","label":"Optional: Start a Dask client","html_id":"optional-start-a-dask-client","implicit":true,"key":"GPTLIJavFH"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Spins up a local Dask scheduler/workers to parallelize IO and computation.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"cGe8lOo4C1"}],"key":"tg8al596Js"}],"key":"f5hC8qPQvd"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from distributed.client import Client\ncl = Client()\ncl","key":"uKOzW4LYJM"},{"type":"output","id":"zhl3UwGyuelIdkbsjuF-t","data":[],"key":"AxrAU8jsO5"}],"key":"poCF6YmXza"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"3) Initialize target cube (template)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"maSdiWLltw"}],"identifier":"id-3-initialize-target-cube-template","label":"3) Initialize target cube (template)","html_id":"id-3-initialize-target-cube-template","implicit":true,"key":"FS20ARuGBZ"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Define chunk sizes and build a template dataset containing only the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"lfZe5krLqw"},{"type":"inlineCode","value":"time","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Jo9ELAoZyp"},{"type":"text","value":" coordinate. This pre-allocates the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ZshS7yK9pN"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"e7OOQnDKZZ"},{"type":"text","value":" store with the desired chunking.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CecguynRQN"}],"key":"lKpSn7JgNi"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Note: Adjust chunk sizes (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"KTZYDDw9IC"},{"type":"inlineCode","value":"x","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"o6oprfptog"},{"type":"text","value":", ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"MjwM0JV26D"},{"type":"inlineCode","value":"y","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"pnApBkdUj5"},{"type":"text","value":", ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"yFL94zrwEz"},{"type":"inlineCode","value":"time","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"dsNYEXMun4"},{"type":"text","value":") to balance memory, IO, and parallelism for your environment.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"llGWvXKMep"}],"key":"JswGkYc7JD"}],"key":"PtVZBuQvpn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\nchunk_size = {\"time\": 1,\"x\": 512*10, \"y\": 512*10}\ntemp_data = da.expand_dims({'time': timestamps.tolist()})\ntemp_das = xr.Dataset({'forest_loss': temp_data})\ntemp_das = temp_das.chunk(chunk_size)\ntemp_das","key":"GrQCbEqalj"},{"type":"output","id":"xfK2AmJj-OxqUp8gsRrSA","data":[],"key":"Au99iBq6Bq"}],"key":"yQ60kx34yl"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Write template to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"c5TtwTPWHM"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OnY9GAKsq1"}],"identifier":"write-template-to-cube-zarr","label":"Write template to cube.zarr","html_id":"write-template-to-cube-zarr","implicit":true,"key":"j35GbRdD2p"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Create the target store with the full time axis and chosen chunks without writing data yet (","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"K7A1qN6ZmR"},{"type":"inlineCode","value":"compute=False","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"T42UkVMEcG"},{"type":"text","value":").","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"uilygHCt25"}],"key":"phttRHea0p"}],"key":"iB5T5Mlx12"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# write tempalte data that has al the timestamps\ntemp_das.forest_loss.attrs.pop(\"_FillValue\")\n\nenc = {\n    \"forest_loss\": {\n        \"_FillValue\": np.nan,\n        \"dtype\": np.float32,\n    }\n}\n\ntemp_das.to_zarr('cube.zarr', mode='w', compute=False, encoding=enc, write_empty_chunks=False, \n                 safe_chunks=True)","key":"LlWpZ72jZq"},{"type":"output","id":"VcxGrP6ZQmA5hZ_IQlZPR","data":[],"key":"l41S20RwCv"}],"key":"lzu9QZgRtI"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Chunking strategy","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZfaZGE8K0U"}],"identifier":"chunking-strategy","label":"Chunking strategy","html_id":"chunking-strategy","implicit":true,"key":"LQlSRgoMoN"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Choose chunk sizes that fit in memory and align with access patterns (typical: larger ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"lpz8MbGivI"},{"type":"inlineCode","value":"x","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DydmSEY5OT"},{"type":"text","value":"/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"IMYYGK161e"},{"type":"inlineCode","value":"y","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eVPMdOeFDc"},{"type":"text","value":", small ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ZXEuUx30AO"},{"type":"inlineCode","value":"time","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QLPPmvLqol"},{"type":"text","value":").","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"TaF47N1suI"}],"key":"KVRn7sa8i0"}],"key":"TBcgPRMJFq"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"You can override chunks when opening inputs, e.g.: ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"pIAWrLgEzV"},{"type":"inlineCode","value":"xr.open_dataset(f, engine=\"zarr\", chunks={\"X\": 512*10, \"Y\": 512*10})","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"ik1dywQiTO"},{"type":"text","value":".","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"mK1cv6brQn"}],"key":"UnmOOrIMU1"}],"key":"lIHGHjYJnJ"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Keep chunk shapes consistent across inputs and the target cube for best performance.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ChBfcD7Lnk"}],"key":"agQDx5Vrmt"}],"key":"OxCR3XyJgL"}],"key":"gUPDiPIqJJ"}],"key":"NvH8YMdmKR"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"4) Append slices to the cube","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MrCPOsBrSm"}],"identifier":"id-4-append-slices-to-the-cube","label":"4) Append slices to the cube","html_id":"id-4-append-slices-to-the-cube","implicit":true,"key":"CIribiiwHW"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"For each per-date Zarr store:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gPnedBfprx"}],"key":"j2JvLoW9wt"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Open with ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"UHdI3lxT9Q"},{"type":"inlineCode","value":"xarray","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"iZ5Z79tyqX"},{"type":"text","value":" and rename dims ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"vhsqd6fciB"},{"type":"inlineCode","value":"X/Y","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"y5nXO7FGz7"},{"type":"text","value":" to ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Zcg13o8Jrt"},{"type":"inlineCode","value":"x/y","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"OxPmKJvFbi"},{"type":"text","value":".","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"cz3vrSjiiU"}],"key":"g4xkOF0C6c"}],"key":"MaBOiQGTJS"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Convert ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"qUOWvlTOaH"},{"type":"inlineCode","value":"0","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"OYNj7xNkPU"},{"type":"text","value":" to missing (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"AXqI7kUEs8"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Kx8VXxwh4S"},{"type":"text","value":") so background doesn’t accumulate and skip writing empty chunks","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"s7ATJ6A076"}],"key":"Uku3dJpnJg"}],"key":"u5ONca0S3s"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Attach CRS (","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"HpO2sZ5gHK"},{"type":"inlineCode","value":"EPSG:4326","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"iHbR7KmYI5"},{"type":"text","value":") and set spatial dims via ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ijz1uH1vr7"},{"type":"inlineCode","value":"rioxarray","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"l2kENnK9sP"},{"type":"text","value":".","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Hytds5nsrE"}],"key":"eKoPBtTX7Q"}],"key":"ad31hwuHLq"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Expand with a singleton ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Jk2QEP6gIJ"},{"type":"inlineCode","value":"time","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"lCyhaVsYPJ"},{"type":"text","value":" coordinate and write into ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ZuVJJT7UBo"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"C0PP9TlEQl"},{"type":"text","value":" at the matching ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"MKHRkGdbcA"},{"type":"inlineCode","value":"time","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"FRz34RIGwv"},{"type":"text","value":" index using ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"j79iK6Hj98"},{"type":"inlineCode","value":"region","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ro4b7OEuoh"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"t9nyFo5vn7"}],"key":"dsFyaIVDyY"}],"key":"LnL6dccKYV"}],"key":"K5Qf6JvF0i"}],"key":"EKAsmMPfwh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"for i, (date, f) in enumerate(zip(timestamps, files)):\n    da = xr.open_dataset(f,\n             engine=\"zarr\", chunks={\"X\": 512*10, \"Y\": 512*10}) \n    da = da[next(iter(da.data_vars))]\n    da = da.rename({\"X\":\"x\", \"Y\":\"y\"})\n    da.name = \"forest_loss\"\n    da = da.where(da != 0)\n    da = da.rio.write_crs(\"EPSG:4326\")\n    da = da.rio.set_spatial_dims(x_dim=\"x\", y_dim=\"y\")   # <-- solves MissingSpatialDimensionError\n    da = da.expand_dims({'time': [date]})\n    da = da.chunk(chunk_size)\n    da.forest_loss.attrs.pop(\"_FillValue\")\n\n    enc = {\n        \"forest_loss\": {\n            \"_FillValue\": np.nan,\n            \"dtype\": np.float32,\n        }\n    }\n    da.drop_vars(['x', 'y', 'spatial_ref']).to_zarr('cube.zarr', encoding=enc, write_empty_chunks=False, safe_chunks=True, region={'time': slice(i, i+1)})\n    print(i)\n","key":"iR3c7mQyZp"},{"type":"output","id":"KL07janq36lXI4ZUOvFFX","data":[],"key":"AYwEw6bdUk"}],"key":"MmBgkL1KOd"}],"key":"kwA3ayvmrS"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Generating STAC collections for the CareHeat project","url":"/careheat-v2","group":"EarthCODE Tutorials"},"next":{"title":"WAPOSAL - Wave power density, zero-crossing wave period, and significant wave height product","url":"/waposal","group":"EarthCODE Tutorials"}}},"domain":"http://localhost:3000"}