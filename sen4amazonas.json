{"version":2,"kind":"Notebook","sha256":"a9be5e99836de376920435f49bb1d8382ed5f516bd607212f84f9342a0f485f3","slug":"sen4amazonas","location":"/PRR/sen4amazonas.ipynb","dependencies":[],"frontmatter":{"title":"Sen4Amazonas: Time-Series Forest Loss Zarr Cube","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"pangeo","language":"python"},"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"MIT","url":"https://opensource.org/licenses/MIT","name":"MIT License","free":true,"osi":true}},"github":"https://github.com/ESA-EarthCODE/tutorials","subject":"EarthCODE Tutorials","numbering":{"title":{"offset":1}},"source_url":"https://github.com/ESA-EarthCODE/tutorials/blob/main/PRR/sen4amazonas.ipynb","edit_url":"https://github.com/ESA-EarthCODE/tutorials/edit/main/PRR/sen4amazonas.ipynb","exports":[{"format":"ipynb","filename":"sen4amazonas.ipynb","url":"/tutorials/build/sen4amazonas-292d2ca7834ece1bb26fa0f574c4e20f.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Goal","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bBdPCAJV4W"}],"key":"APBeEv5vrZ"},{"type":"text","value":": Produce a time-indexed Zarr data cube of forest-loss masks for the Amazonas region to enable scalable analysis and visualization. This example is based on the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qYc1PJWzuk"},{"type":"link","url":"https://sen4ama.gisat.cz/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Sentinel for amazonas project","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"M5inP7qiAl"}],"urlSource":"https://sen4ama.gisat.cz/","key":"XE7aJx2HGF"},{"type":"text","value":" project.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XJzaBeWirF"}],"key":"cAJH71RZvH"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Classes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ow3lllW0QN"}],"key":"VMJfuUQSYb"},{"type":"text","value":":","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Rj260qaPZe"}],"key":"Z97f2fOrDz"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"1","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"muwNTO31VN"},{"type":"text","value":" — forest loss","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"tPtHWpUXRQ"}],"key":"liEafbctLZ"}],"key":"EZ6CmeCOiO"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"0","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"gXl4x36Am5"},{"type":"text","value":" — no data / background (treated as missing)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"CV2rGtUoVp"}],"key":"atndLNzszU"}],"key":"ddGtj8Uzxj"}],"key":"tcFXGKAFUb"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Study area and grid","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"HxRaorFnIY"}],"key":"bur0RG7pyh"},{"type":"text","value":":","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"nAD1pSLkJM"}],"key":"Oyedx0Yy1k"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":10,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"CRS: ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"SYGifowatL"},{"type":"inlineCode","value":"EPSG:4326","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"ZBxCMLjjre"}],"key":"J5GjANYnG8"}],"key":"WK5WWRuYnT"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Bounds: ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"jS8ZbJ3tfb"},{"type":"inlineCode","value":"-79.1997438, -17.27354892, -44.91217178, 9.0467434","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"WHtnzoQs7T"}],"key":"SOSuqpWf7z"}],"key":"D05OeS1k5b"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Resolution: ","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"HZZK4ew9QT"},{"type":"inlineCode","value":"0.00017966","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"sm7TST8Heq"},{"type":"text","value":" degrees (see ","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"pYZyuzxm67"},{"type":"inlineCode","value":"gdalwarp","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"yeG2huFHXC"},{"type":"text","value":" step)","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"s9d8BPUbtW"}],"key":"HW7ipdevdK"}],"key":"yiWkwXv5O8"}],"key":"klhgCafbH1"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"strong","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Workflow overview","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"bJJDtR8UKB"}],"key":"nDMNrj6wJF"},{"type":"text","value":":","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"jSIg3qQsNv"}],"key":"GKYVaGlj12"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":15,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Convert each GeoTIFF mosaic to per-date Zarr with ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"kfGXc8iveW"},{"type":"inlineCode","value":"gdalwarp","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"Hdgke4acl9"},{"type":"text","value":".","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"b6GWFYh9iT"}],"key":"P9MyKugbMD"}],"key":"GsZavdKgRT"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Build a sorted list of Zarr stores and timestamps.","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"DmbjvuXICl"}],"key":"FISVEiIe84"}],"key":"TqTEk5yLsV"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Initialize an empty target cube (","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"fPLLwK4v8z"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"ng8i8A0Abe"},{"type":"text","value":") with the full time axis.","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"LaQ15MvTQ2"}],"key":"PJbnGne0GN"}],"key":"Sa5qinv2Hh"},{"type":"listItem","spread":true,"position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Append each slice into the cube using ","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"JpCoMXdyah"},{"type":"inlineCode","value":"region","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"Nkm2XDNLfj"},{"type":"text","value":" writes.","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"SIFAINnVxJ"}],"key":"C5RSD3t9AI"}],"key":"rhU1fFUQI5"},{"type":"listItem","spread":true,"position":{"start":{"line":19,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Tune chunking for performance and memory.","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"S9FIdAkREX"}],"key":"wzq2H2Fk9r"}],"key":"VxmbEUGwOQ"}],"key":"Pv3pkIm1kk"},{"type":"paragraph","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"strong","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"Requirements","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"sd2Wgznvh7"}],"key":"n3v3irW9Si"},{"type":"text","value":":","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"mM4WC7iVPn"}],"key":"fGf3Gak8NM"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":22,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"GDAL built with Zarr driver (","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"acxnDTZd9x"},{"type":"inlineCode","value":"gdalwarp -of Zarr","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"p4SlYDPBkn"},{"type":"text","value":")","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"Xzx44xrtOw"}],"key":"sBgD0zYgI3"}],"key":"XG6a79PVzX"},{"type":"listItem","spread":true,"position":{"start":{"line":23,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Python: ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"Xpjbfy2Rsm"},{"type":"inlineCode","value":"xarray","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"BgOWJos8iB"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"D5gQUA3V2x"},{"type":"inlineCode","value":"rioxarray","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"IaFhBJL2wp"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"qZkT9v57LT"},{"type":"inlineCode","value":"zarr","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"mX6IYoZRo6"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"Qfhyy0fTUs"},{"type":"inlineCode","value":"dask[distributed]","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"adzaTJHevP"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"m6g91CRQMt"},{"type":"inlineCode","value":"numpy","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"EBcp76HkZP"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"sXIN43Ua2y"},{"type":"inlineCode","value":"pandas","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"bnFDi8Zfs2"},{"type":"text","value":", optionally ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"X0ZBI7yX7m"},{"type":"inlineCode","value":"hvplot.xarray","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"Vkw6DOxdHp"},{"type":"text","value":" for quick QA","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"A0dQW68xxu"}],"key":"cu03HT2iUc"}],"key":"mHCBhSFN0J"}],"key":"QS3hEGuVE9"},{"type":"paragraph","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"strong","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"Data layout","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"T6hgzNGW9N"}],"key":"xXue0lzWBC"},{"type":"text","value":":","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"V4xqdUOqUK"}],"key":"jB4BAtex4n"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":26,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Input: ","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"QxnBC6ZUoA"},{"type":"inlineCode","value":"mosaics/*.tif","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"Y6rrUTY16A"},{"type":"text","value":" (per-date masks)","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"jBD3M3uBGq"}],"key":"Z6dsYpsuFm"}],"key":"Mnd3wYLvQe"},{"type":"listItem","spread":true,"position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Intermediate: ","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"oppGDY0fdj"},{"type":"inlineCode","value":"mosaics/*.zarr","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"YRQMix94gq"},{"type":"text","value":" (per-date stores)","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"urY8eX3cHa"}],"key":"eDAEbxKalO"}],"key":"d1ACtrgIIK"},{"type":"listItem","spread":true,"position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Output: ","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"lAg4b3zgme"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"VkrVgfAPGW"},{"type":"text","value":" (time-series cube)","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"g7q86CoZpa"}],"key":"WQmgfdmWes"}],"key":"awpZb8B6N8"}],"key":"NVnTerd9Oh"}],"key":"AWVXvNGg6H"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Discussion","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RixFgDXQZ6"}],"identifier":"discussion","label":"Discussion","html_id":"discussion","implicit":true,"key":"nrIlDBGa4v"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"When handling many temporal slices in Earth Observation, storing them as a single Zarr data cube is far superior to managing hundreds of COGs linked via a STAC collection because Zarr treats time as a first-class dimension within a unified array structure rather than as disconnected files. This enables efficient temporal queries and parallel access using chunked, compressed blocks that map directly to analysis patterns like pixel-wise time series or rolling statistics, all without the per-file latency, catalog management, and HTTP overhead that cripple COG-based stacks at scale.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tMBty4lDiY"}],"key":"DmmilgTNkK"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"To learn more read the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"ywsh6FyCGt"},{"type":"link","url":"https://esa-earthcode.github.io/documentation/Community%20and%20Best%20Practices/Data%20and%20Workflow%20Best%20Practices/Data/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"EarthCODE data best practices pages","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"fn1Q6u7tJL"}],"urlSource":"https://esa-earthcode.github.io/documentation/Community%20and%20Best%20Practices/Data%20and%20Workflow%20Best%20Practices/Data/","key":"zEuzguuR95"}],"key":"uwHpqNCNxO"}],"key":"mk5ogqUiFD"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"1) Convert GeoTIFFs to Zarr with GDAL","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OFinbi3kvp"}],"identifier":"id-1-convert-geotiffs-to-zarr-with-gdal","label":"1) Convert GeoTIFFs to Zarr with GDAL","html_id":"id-1-convert-geotiffs-to-zarr-with-gdal","implicit":true,"key":"uALjdBA8h7"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Use GDAL to warp each input GeoTIFF to ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qVREeaW1sM"},{"type":"inlineCode","value":"EPSG:4326","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"hFFQujdapx"},{"type":"text","value":", clip to the Amazonas extent, set the target resolution, and write per-date Zarr stores. Adjust ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"xRgTyrAuDY"},{"type":"inlineCode","value":"IN_DIR","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qkrqJ6US5p"},{"type":"text","value":", ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"c1sXp4ZmbC"},{"type":"inlineCode","value":"OUT_DIR","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BfU5MhgKvx"},{"type":"text","value":", bounds (","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BvnJ4Qs0B9"},{"type":"inlineCode","value":"-te","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Jclef5pNbn"},{"type":"text","value":"), resolution (","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wYLLm9IO5L"},{"type":"inlineCode","value":"-tr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"DCjxhfAdAH"},{"type":"text","value":"), and compression to match your data and hardware.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"JaXQ2DVkDZ"}],"key":"PrYRdJK0BM"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Tip: Confirm Zarr support with ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"gSF8sFChow"},{"type":"inlineCode","value":"gdalinfo --formats | grep -i zarr","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"xQaiIkbCIp"},{"type":"text","value":".","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"CdFmy6jYBn"}],"key":"Xvw7yWnmLN"}],"key":"Cm2N6FAlhn"},{"type":"block","kind":"notebook-content","children":[{"type":"code","lang":"bash","value":"%%bash\n#!/usr/bin/env bash\nset -euo pipefail\n\nIN_DIR=\"mosaics\"\nOUT_DIR=\"mosaics\"\n\nfor tif in \"${IN_DIR}\"/*.tif; do\n  base=\"$(basename \"${tif}\" .tif)\"\n  out=\"${OUT_DIR}/${base}.zarr\"\n\n  echo \"Warping ${tif} -> ${out}\"\n  gdalwarp -overwrite \\\n    -t_srs EPSG:4326 \\\n    -te -79.1997438 -17.27354892 -44.91217178 9.0467434 \\\n    -tr 0.00017966 0.00017966 \\\n    -r near \\\n    -dstnodata 0 \\\n    \"${tif}\" \\\n    \"${out}\" \\\n    -of Zarr \\\n    -multi -wo NUM_THREADS=ALL_CPUS \\\n    -co COMPRESS=ZSTD -co ZSTD_LEVEL=3 -co BLOCKSIZE=512,512\n\ndone","position":{"start":{"line":1,"column":1},"end":{"line":27,"column":1}},"key":"JhIMdpSlvC"}],"key":"OxuluFPXOt"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2) Python setup and file discovery","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Nanvx0WpFE"}],"identifier":"id-2-python-setup-and-file-discovery","label":"2) Python setup and file discovery","html_id":"id-2-python-setup-and-file-discovery","implicit":true,"key":"eju3skZQ2o"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Import libraries, set the input folder (","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WBdblaMe7P"},{"type":"inlineCode","value":"mosaics/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"SWWMBQFf4w"},{"type":"text","value":"), and collect per-date Zarr stores produced in step 1. Timestamps are parsed from filenames like ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VoTOcp5c8F"},{"type":"inlineCode","value":"prefix_YYYYMMDD.zarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pq4YRbHa5E"},{"type":"text","value":". If your naming differs, adjust the parsing logic accordingly.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"CP3rgm8phG"}],"key":"UelChM5PjA"}],"key":"rWxygAK8Jb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport rioxarray\nimport xarray as xr\nimport hvplot.xarray\nimport pandas as pd\nfrom pathlib import Path\n\nfolder = \"mosaics\"\nfiles = [os.path.join(folder, f) for f in os.listdir(folder) if f.endswith(\".zarr\")]\n# print(files)\n\ntimestamps = [\n    pd.to_datetime(os.path.splitext(Path(f).name)[0].split(\"_\")[1]) for f in files\n]\n# timestamps","key":"bfQ7c3UtL5"},{"type":"output","id":"W9_11zUmYxSHJ2Bo5GzdM","data":[],"key":"drmg2uCJ5s"}],"key":"k0AagfOzIC"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Sort files by timestamp","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WcVWCP7zk1"}],"identifier":"sort-files-by-timestamp","label":"Sort files by timestamp","html_id":"sort-files-by-timestamp","implicit":true,"key":"zPYITRN89B"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Ensure files and timestamps are aligned chronologically for consistent time indexing.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"ULJdH3wgI1"}],"key":"plidJTOQYq"}],"key":"VjwpLdq6Wm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\nii = np.argsort(timestamps)\ntimestamps = np.array(timestamps)[ii]\nfiles = np.array(files)[ii]\n# files","key":"czM5mj1vCU"},{"type":"output","id":"o9zptHvt99s_sPeRotlwa","data":[],"key":"ErsuJmCTdp"}],"key":"uIIq3YVQMe"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Optional: Start a Dask client","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xfK5U0vLye"}],"identifier":"optional-start-a-dask-client","label":"Optional: Start a Dask client","html_id":"optional-start-a-dask-client","implicit":true,"key":"zippYg7mMp"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Spins up a local Dask scheduler/workers to parallelize IO and computation.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"mMJLAlB1Qv"}],"key":"FH68G6HU0R"}],"key":"LhKAAhLOS0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from distributed.client import Client\ncl = Client()\ncl","key":"wVmO8twIuB"},{"type":"output","id":"UfTL9A0mRCsRfOvt619Jf","data":[],"key":"oIcz6Or6MG"}],"key":"jMFPSv3EUE"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"3) Initialize target cube (template)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"buA52PM34g"}],"identifier":"id-3-initialize-target-cube-template","label":"3) Initialize target cube (template)","html_id":"id-3-initialize-target-cube-template","implicit":true,"key":"HleTzxmpDP"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Define chunk sizes and build a template dataset containing only the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"p6xxtIBnWw"},{"type":"inlineCode","value":"time","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"sun9omjGpz"},{"type":"text","value":" coordinate. This pre-allocates the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"n2f3kfgxpg"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gOuuRA2mtZ"},{"type":"text","value":" store with the desired chunking.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QnhVsckT3g"}],"key":"Lz478HGQ7u"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Note: Adjust chunk sizes (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"bs9UEN2XEY"},{"type":"inlineCode","value":"x","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"UJxP7K2j3Z"},{"type":"text","value":", ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Fe1feGFAC2"},{"type":"inlineCode","value":"y","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"wtFRaRhngB"},{"type":"text","value":", ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"dlWwknJH1X"},{"type":"inlineCode","value":"time","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"pTUpkbhZKj"},{"type":"text","value":") to balance memory, IO, and parallelism for your environment.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"KeA5pOfUem"}],"key":"zCw5jNWGwa"}],"key":"wVvWU17UQ0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\nchunk_size = {\"time\": 1,\"x\": 512*10, \"y\": 512*10}\ntemp_data = da.expand_dims({'time': timestamps.tolist()})\ntemp_das = xr.Dataset({'forest_loss': temp_data})\ntemp_das = temp_das.chunk(chunk_size)\ntemp_das","key":"wEkCGQQrLx"},{"type":"output","id":"kU9SQtCKU1TfnuhMW1wdE","data":[],"key":"VfM08cPsum"}],"key":"Y7oO9lp8AX"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Write template to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iy0D7LVAmv"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tdtwgEFfJx"}],"identifier":"write-template-to-cube-zarr","label":"Write template to cube.zarr","html_id":"write-template-to-cube-zarr","implicit":true,"key":"ImjX8araQX"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Create the target store with the full time axis and chosen chunks without writing data yet (","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"sbLSoEnHOS"},{"type":"inlineCode","value":"compute=False","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"y1209g9rAM"},{"type":"text","value":").","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"WfIXd9pmqq"}],"key":"LQSkknvhPb"}],"key":"rtTNvRuXs7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# write tempalte data that has al the timestamps\ntemp_das.forest_loss.attrs.pop(\"_FillValue\")\n\nenc = {\n    \"forest_loss\": {\n        \"_FillValue\": np.nan,\n        \"dtype\": np.float32,\n    }\n}\n\ntemp_das.to_zarr('cube.zarr', mode='w', compute=False, encoding=enc, write_empty_chunks=False, \n                 safe_chunks=True)","key":"JH0wO6GFHk"},{"type":"output","id":"lEBbt5iBt9YbWOpGkB4Ru","data":[],"key":"AHNSI62q35"}],"key":"dbVc9TAe95"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Chunking strategy","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MGnOnmiYrV"}],"identifier":"chunking-strategy","label":"Chunking strategy","html_id":"chunking-strategy","implicit":true,"key":"s5PWT2UzYp"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Choose chunk sizes that fit in memory and align with access patterns (typical: larger ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"eUKYfMUlja"},{"type":"inlineCode","value":"x","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bsbvzEWpE0"},{"type":"text","value":"/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"k1hErSQp7i"},{"type":"inlineCode","value":"y","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Nyd3B58vD3"},{"type":"text","value":", small ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"mUpcBI2pjo"},{"type":"inlineCode","value":"time","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VxkfDvFEUw"},{"type":"text","value":").","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vQbi7p1lru"}],"key":"YzHy8wdf3d"}],"key":"cus9CfZDhG"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"You can override chunks when opening inputs, e.g.: ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"ttA11nN52N"},{"type":"inlineCode","value":"xr.open_dataset(f, engine=\"zarr\", chunks={\"X\": 512*10, \"Y\": 512*10})","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"FrKGyxY95s"},{"type":"text","value":".","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"V2yJgjy0V9"}],"key":"LajXLi6SnR"}],"key":"A5tH7oaYKL"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Keep chunk shapes consistent across inputs and the target cube for best performance.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"f5vQECBD95"}],"key":"P7LgIUT6rO"}],"key":"Q4FWU0QvbL"}],"key":"RYlCgzAoWd"}],"key":"GcjCkwAb4M"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"4) Append slices to the cube","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CZos0C0NIS"}],"identifier":"id-4-append-slices-to-the-cube","label":"4) Append slices to the cube","html_id":"id-4-append-slices-to-the-cube","implicit":true,"key":"NIxfugFjX4"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"For each per-date Zarr store:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"et39TY4sXL"}],"key":"qBE5Td7C3x"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Open with ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Q3Jfhzhm70"},{"type":"inlineCode","value":"xarray","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"vbxfJ3wErP"},{"type":"text","value":" and rename dims ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"pAcNKNeA2B"},{"type":"inlineCode","value":"X/Y","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Zlydeyk4BD"},{"type":"text","value":" to ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"CearBwbMhZ"},{"type":"inlineCode","value":"x/y","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"DsEk017mfb"},{"type":"text","value":".","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"F5LEyM65o1"}],"key":"xgVsd4EAzU"}],"key":"fUf5s39x43"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Convert ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"T9eR0y11QA"},{"type":"inlineCode","value":"0","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Q6mkP7RkbU"},{"type":"text","value":" to missing (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"O7CmA6tJFK"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"dnqIXtUO1j"},{"type":"text","value":") so background doesn’t accumulate and skip writing empty chunks","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"d5X9K0TiSh"}],"key":"epgQ6fdZUV"}],"key":"uw5LZJxEVw"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Attach CRS (","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"UOvsf21On1"},{"type":"inlineCode","value":"EPSG:4326","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"SHDENGiqIB"},{"type":"text","value":") and set spatial dims via ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"HEbk4RAZnm"},{"type":"inlineCode","value":"rioxarray","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"QBDEQbFoch"},{"type":"text","value":".","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Yvf4gLkwWX"}],"key":"E6ml492QPw"}],"key":"xtOcn5zuAH"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Expand with a singleton ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"uICRgiH4Xq"},{"type":"inlineCode","value":"time","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"yYohpfU7cU"},{"type":"text","value":" coordinate and write into ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"mziIbqFX4s"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"UVUR34jmAx"},{"type":"text","value":" at the matching ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"kC10m9ElNz"},{"type":"inlineCode","value":"time","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"ihBvCY89dA"},{"type":"text","value":" index using ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"uJaIME2IJN"},{"type":"inlineCode","value":"region","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"l2jTAJSJKu"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"IcxaK9gSOl"}],"key":"kdWNOOS49T"}],"key":"T3eVwrT6OS"}],"key":"OQ9XXrpndi"}],"key":"rXugqoRmcb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"for i, (date, f) in enumerate(zip(timestamps, files)):\n    da = xr.open_dataset(f,\n             engine=\"zarr\", chunks={\"X\": 512*10, \"Y\": 512*10}) \n    da = da[next(iter(da.data_vars))]\n    da = da.rename({\"X\":\"x\", \"Y\":\"y\"})\n    da.name = \"forest_loss\"\n    da = da.where(da != 0)\n    da = da.rio.write_crs(\"EPSG:4326\")\n    da = da.rio.set_spatial_dims(x_dim=\"x\", y_dim=\"y\")   # <-- solves MissingSpatialDimensionError\n    da = da.expand_dims({'time': [date]})\n    da = da.chunk(chunk_size)\n    da.forest_loss.attrs.pop(\"_FillValue\")\n\n    enc = {\n        \"forest_loss\": {\n            \"_FillValue\": np.nan,\n            \"dtype\": np.float32,\n        }\n    }\n    da.drop_vars(['x', 'y', 'spatial_ref']).to_zarr('cube.zarr', encoding=enc, write_empty_chunks=False, safe_chunks=True, region={'time': slice(i, i+1)})\n    print(i)\n","key":"uLOnISF8YQ"},{"type":"output","id":"oBPL0S5cjW6cVoiR9Vwr6","data":[],"key":"m0l5LeAbzC"}],"key":"YJ9rkCsLya"}],"key":"xLFpvd9n2g"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Generating STAC collections for the CareHeat project","url":"/careheat-v2","group":"EarthCODE Tutorials"},"next":{"title":"WAPOSAL - Wave power density, zero-crossing wave period, and significant wave height product","url":"/waposal","group":"EarthCODE Tutorials"}}},"domain":"http://localhost:3000"}