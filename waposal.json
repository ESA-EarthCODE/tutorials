{"version":2,"kind":"Notebook","sha256":"714602e57f4d9d85a5145a1a006c21e7596d670dcb079ae2a343b9d6269a9cfb","slug":"waposal","location":"/PRR/waposal.ipynb","dependencies":[],"frontmatter":{"title":"WAPOSAL - Wave power density, zero-crossing wave period, and significant wave height product","content_includes_title":false,"kernelspec":{"name":"conda-env-micromamba-pangeo-py","display_name":"Python [conda env:micromamba-pangeo] *","language":"python"},"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"MIT","url":"https://opensource.org/licenses/MIT","name":"MIT License","free":true,"osi":true}},"github":"https://github.com/ESA-EarthCODE/tutorials","subject":"EarthCODE Tutorials","numbering":{"title":{"offset":1}},"source_url":"https://github.com/ESA-EarthCODE/tutorials/blob/main/PRR/waposal.ipynb","edit_url":"https://github.com/ESA-EarthCODE/tutorials/edit/main/PRR/waposal.ipynb","exports":[{"format":"ipynb","filename":"waposal.ipynb","url":"/tutorials/build/waposal-ce60200cd29b62da0b264e3880965246.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"This notebook shows how to","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XCpYYnFJzX"}],"key":"RU0SyP7RNM"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Combine a number of .nc files into a .zarr","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"AAUgwU9qky"}],"key":"JG45WrIB3n"}],"key":"MK04WhGO5C"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Generate a valid STAC collection, which is a requirement to upload research outcomes to the ESA Project Results Repository (PRR).","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"faG58Q7K65"}],"key":"hMD2fyZhIJ"}],"key":"C2wNmLKaxT"}],"key":"PPTLttCJ6R"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"The code below demonstrates how to perform the necessary steps using real data from the ESA project WAPOSAL. The focus of WAPOSAL is to analyse wave power density, zero-crossing wave period, and significant wave height product obtained along track based on Sentinel-3 A/B and Cryosat-2 altimeter data processed by SAMOSA+ retracker.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"GDqFkEcQIJ"}],"key":"v7aYFMss8c"},{"type":"paragraph","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Check the ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"HUCo0d4QCy"},{"type":"link","url":"https://earthcode.esa.int/","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"EarthCODE documentation","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"gRNd3Ercus"}],"urlSource":"https://earthcode.esa.int/","key":"XG5GTUFYyL"},{"type":"text","value":", and ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"YH0q7JrvIR"},{"type":"link","url":"https://esa-earthcode.github.io/tutorials/prr-stac-introduction","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"PRR STAC introduction example","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"yOxpyl8nrw"}],"urlSource":"https://esa-earthcode.github.io/tutorials/prr-stac-introduction","key":"EucNW32tAb"},{"type":"text","value":" for a more general introduction to STAC and the ESA PRR.","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"K1Ti7JBaej"}],"key":"O1RiYr7YhF"},{"type":"paragraph","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"ðŸ”— Check the project website: ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"MQrWFwi07r"},{"type":"link","url":"https://waposal.tecnico.ulisboa.pt/~waposal.daemon/","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"WAPOSAL â€“ Website","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"igoyrhf7pf"}],"urlSource":"https://waposal.tecnico.ulisboa.pt/~waposal.daemon/","key":"eSzW24pT5N"}],"key":"yMWUnFV6l8"},{"type":"paragraph","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"ðŸ”— Check the eo4society page: ","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"FhSXTOOSWZ"},{"type":"link","url":"https://eo4society.esa.int/projects/waposal/","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"WAPOSAL â€“ eo4society","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"J8TYXa5LI8"}],"urlSource":"https://eo4society.esa.int/projects/waposal/","key":"GtnYSxidRb"}],"key":"QH5E8CxwGP"},{"type":"heading","depth":3,"position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"Acknowledgment","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"xCcoiDyhfx"}],"identifier":"acknowledgment","label":"Acknowledgment","html_id":"acknowledgment","implicit":true,"key":"cHOLKm34kA"},{"type":"paragraph","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"We gratefully acknowledge the ","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"DaNy28Sqys"},{"type":"strong","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"WAPOSAL","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"KAOiJR3qsY"}],"key":"PdpVRJb3FA"},{"type":"text","value":" team for providing access to the data used in this example, as well as their support in creating it.","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"bttZII3Zwg"}],"key":"nUlFWtrCNe"},{"type":"heading","depth":2,"position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"text","value":"Combine the multiple trajectory files into zarr stores.","position":{"start":{"line":24,"column":1},"end":{"line":24,"column":1}},"key":"trUSpNGNg2"}],"identifier":"combine-the-multiple-trajectory-files-into-zarr-stores","label":"Combine the multiple trajectory files into zarr stores.","html_id":"combine-the-multiple-trajectory-files-into-zarr-stores","implicit":true,"key":"dr1xF77hCl"}],"key":"bV1w3WpNNo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from pathlib import Path\nimport numpy as np\nimport xarray as xr\nimport re\nimport os\nfrom joblib import Parallel, delayed\nimport pickle","key":"juCiCwyHBl"},{"type":"output","id":"-lCi5mE9rY-kA9csr3JyX","data":[],"key":"SCdFwqmd2P"}],"key":"taehdqoZpw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# define region information\nbbox_ = {}\nbbox_['UK'] = [-11.0,47.5,10.0,60.0]\nbbox_['BN'] = [3.0,53.0,30.35,72.0]\nbbox_['FF'] = [-10.0,43.0,-0.5,49.0]\nbbox_['NS'] = [-10.0,42.0,-1.0,45.0]\nbbox_['FP'] = [-155.0,-27.0,-134.0,-7.0]\nbbox_['MT'] = [-6.0,30.1,41.8,47.4]\nbbox_['FG'] = [-54.0,4.1,-51.5,6.0]\nbbox_['CN'] = [-19.0,26.0,-10.0,31.0]\nbbox_['PT'] = [-10.0,37.0,-8.0,42.0]\nbbox_['MD'] = [-18.5,27.0,-13.0,30.0]\nbbox_['AZ'] = [-32.0,36.5,-24.0,40.0]\n\nsatellite_names = {'S3A': 'Sentinel-3', 'S3B': 'Sentinel-3','CS2': 'CryoSat-2'}\nplatform_id = {'S3A': 'A', 'S3B': 'B','CS2': ''}\nsensor = {'S3A': 'SRAL', 'S3B': 'SRAL','CS2': 'SIRAL'}\nzone = {'AZ': 'Azores', \n        'FG': 'French Guiana', \n        'FF': 'French Facade', \n        'UK': 'UK', \n        'FP': 'French Polinesia',\n        'CN': 'Canaries',\n        'PT': 'Portugal',\n        'NS': 'North Spain',\n        'BN': 'Baltic and Norway',\n        'MT': 'Mediterranean',\n        'MD': 'Madeira'}\n\nepoch_2000 = np.datetime64('2000-01-01T00:00:00')","key":"pX1g8sCO0k"},{"type":"output","id":"C_RgOo5gukl3n8edDp_hr","data":[],"key":"z27MApKl0X"}],"key":"ZOWijqpsQs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def return_temporal_size(f):\n    return xr.open_dataset(f, decode_timedelta=False).time.shape[0]\n\n\ndef combine_to_trajectory_zarr(region, satellite, files):\n\n    # # define the coordinates shapes\n    # sizes = Parallel(n_jobs=-1)(delayed(return_temporal_size)(f) for f in files)\n    # max_obs = max(sizes)\n    # trajectories_len = len(files)\n    # obs_len = max_obs\n\n    # read coordinate shapes\n    trajectories_len, obs_len = dimensions[f'{region}-{satellite}']\n    join_strategy = 'exact' if obs_len is not None else 'outer'\n    \n    datasets_list = []\n    \n    for filepath in files:\n    \n        # open file and drop dim\n        ds = xr.open_dataset(filepath, decode_times=False)\n        ds = ds.sel(dim=0)\n        \n        # rename the 'time' dimension to 'obs'\n        ds = ds.rename_dims({'time': 'obs'})\n        \n        # pad to maximum observations\n        ds = ds.pad(obs=(0, obs_len - ds.obs.size), mode='constant', constant_values=np.nan)\n    \n        # expand trakectory dimension\n        ds = ds.expand_dims('trajectory')\n        \n        # Create the 'trajectory_info' variable\n        filename = os.path.basename(filepath)\n        ds['trajectory_info'] = xr.DataArray(\n            [filename],  # Data is the filename\n            dims=['trajectory'],  # Depends on the new dimension\n            attrs={'long_name': 'trajectory info'} # Add attributes\n        )\n    \n        # add to concat list\n        datasets_list.append(ds)\n\n    # combine the datasets\n    combined_ds = xr.concat(\n        datasets_list, \n        dim='trajectory', \n        join=join_strategy, \n        fill_value=np.nan\n    )\n\n    del datasets_list\n    \n    # # update metadata\n    combined_ds = combined_ds.chunk(trajectory=1000)\n    start_time = epoch_2000 + np.timedelta64(int(combined_ds.TAI_Time_20Hz.isel(trajectory=0).min(skipna=True).values), 's')\n    end_time = epoch_2000 + np.timedelta64(int(combined_ds.TAI_Time_20Hz.isel(trajectory=-1).max(skipna=True).values), 's')\n    \n    combined_ds.attrs.update({\n        \"Conventions\" : \"CF-1.6/CF-1.7\",\n        \"feature_type\" :\"trajectory\",\n        \"start_datetime\": str(start_time),\n        \"end_datetime\": str(end_time),\n        \"created\": '2025-11-14T00:00:00Z',        \n        \"description\": f\"Wave power density, zero-crossing wave period, and significant wave height product obtained along-track from {satellite_names[satellite]} altimeter data processed by SAMOSA+ retracker over the {zone[region]} region.\",\n        \"zone\": zone[region], # region for example Azores        \n        \"platform_name\": satellite,\n        \"institution\": 'CENTEC-IST-ID',\n        \"license\": \"CC-BY-SA-4.0\",\n        \"min_lon\": bbox_[region][0],\n        \"min_lat\": bbox_[region][1],\n        \"max_lon\": bbox_[region][2],\n        \"max_lat\": bbox_[region][3],\n        \"crs\": 'epsg:4326',\n        \"referencfe\": \"https://opensciencedata.esa.int/products/waposal-waves/collection\"\n    })\n\n    return combined_ds","key":"tJn9dwx9uX"},{"type":"output","id":"_68pekkqT2sKU8tuVvWhU","data":[],"key":"TsEqfw8rvs"}],"key":"azA63xAkrq"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"rootpath = \"/mnt/d/data/waposal/extracted/\"\nregions = ['AZ', 'BN', 'CN', 'FF', 'FG', 'FP', 'MD', 'MT', 'NS', 'PT', 'UK']\nsatellites = ['S3A', 'S3B', 'CS2']","key":"QqWV34Jcsn"},{"type":"output","id":"NSp02U6gORPeYBB6E6ddS","data":[],"key":"vSPTJtotsJ"}],"key":"rUVhC90eKB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"","key":"D8Usbe3iJT"},{"type":"output","id":"Z3DAcKa3r-5y6ruOmN-OH","data":[],"key":"P1K7hLe8Nc"}],"key":"r3UlcXbksj"},{"type":"block","kind":"notebook-code","data":{"scrolled":true},"children":[{"type":"code","lang":"python","executable":true,"value":"# define the dimensions of each zarr store.\n# We need to know this ahead of time, to align all the observations\nimport gc\nfrom joblib import Parallel, delayed\ndef return_temporal_size(f):\n    return xr.open_dataset(f, decode_timedelta=False).time.shape[0]\n\ndimensions = {}\n\nfor region in regions[3:]:\n    for satellite in satellites:\n        print(region + '-' + satellite)\n        files = sorted(Path(f'{rootpath}/{region}/{region}/{satellite}/').glob(\"./*/**/*.nc\"))\n        if len(files) == 0: continue\n        sizes = Parallel(n_jobs=-1)(delayed(return_temporal_size)(f) for f in files)\n        obs_len = max(sizes)\n        trajectories_len = len(files)\n        dimensions[f'{region}-{satellite}'] = (trajectories_len, obs_len)\n        del sizes\n        gc.collect()\n\nwith open('dimensions.pkl', 'wb') as f:\n    pickle.dump(dimensions, f)","key":"wmcD2dQe5V"},{"type":"output","id":"uSdfrlKD3Q9DJ1Qjm4z4V","data":[],"key":"Q9JAsyGtbX"}],"key":"sMv38Q04z0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"","key":"MmkZSod3nS"},{"type":"output","id":"nClZTu3UoWVnJ6CFM6IVX","data":[],"key":"rVuXtzYVeC"}],"key":"f4mOBLrVDF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"","key":"qfwGJpurn5"},{"type":"output","id":"OzJqtHjPaKb2QirW2FoEq","data":[],"key":"DonsCIZx5d"}],"key":"jlstaiaWUU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"with open('dimensions.pkl', 'rb') as f:\n    dimensions = pickle.load(f)","key":"Jbvxmal9f1"},{"type":"output","id":"sjFiafpDdVJFuPcAMJPgE","data":[],"key":"fm2vMIbq01"}],"key":"CLr3cTsXPR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dimensions","key":"iVc94huihk"},{"type":"output","id":"nhc1QuHDVIwZt-PUV-Mvf","data":[{"output_type":"execute_result","execution_count":8,"metadata":{},"data":{"text/plain":{"content":"{'AZ-S3A': (1711, 1218),\n 'AZ-S3B': (1019, 1227),\n 'AZ-CS2': (1554, 573),\n 'BN-S3A': (8719, 6882),\n 'BN-S3B': (5302, 6927),\n 'BN-CS2': (8632, 5309),\n 'CN-S3A': (1998, 1735),\n 'CN-S3B': (1259, 1750),\n 'FF-S3A': (2274, 2095),\n 'FF-S3B': (1608, 2112),\n 'FF-CS2': (4533, 2245),\n 'FG-S3A': (527, 658),\n 'FG-S3B': (327, 658),\n 'FP-S3A': (4864, 6885),\n 'FP-S3B': (3046, 6956),\n 'FP-CS2': (1668, 7019),\n 'MD-S3A': (1248, 1041),\n 'MD-S3B': (778, 1050),\n 'MD-CS2': (4406, 2929),\n 'MT-S3A': (10339, 6263),\n 'MT-S3B': (6344, 6072),\n 'MT-CS2': (21047, 5495),\n 'NS-S3A': (1867, 1046),\n 'NS-S3B': (1210, 1061),\n 'NS-CS2': (3453, 1123),\n 'PT-S3A': (625, 1740),\n 'PT-S3B': (445, 1740),\n 'PT-CS2': (4208, 3932),\n 'UK-S3A': (5322, 4488),\n 'UK-S3B': (3273, 4434),\n 'UK-CS2': (9520, 4671)}","content_type":"text/plain"}}}],"key":"kcNm3pGRi2"}],"key":"hDvxe45wcI"},{"type":"block","kind":"notebook-code","data":{"scrolled":true},"children":[{"type":"code","lang":"python","executable":true,"value":"import gc\nfor region in regions:\n    for satellite in satellites:\n        print(region + '-' + satellite)\n        files = sorted(Path(f'{rootpath}/{region}/{region}/{satellite}/').glob(\"./*/**/*.nc\"))\n        if len(files) == 0:\n            continue\n        ds = combine_to_trajectory_zarr(region, satellite, files)\n        ds.to_zarr(f'{rootpath}combined/{region}-{satellite}.zarr', mode='w', write_empty_chunks=False, zarr_format=2)\n        del ds\n        gc.collect()","key":"OFpZQoQmlx"},{"type":"output","id":"Tt1M2XRxqwg4bANRC097U","data":[],"key":"Mjgb0IANes"}],"key":"mwnlY8eCfQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"","key":"sSyUWnNfNJ"},{"type":"output","id":"PVkLia5eO61puRgMtZpk9","data":[],"key":"fkeTKHHaVi"}],"key":"Rey6aqz938"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"## assert values are not changed between the originals and zarr store\nfor i, f in zip(np.arange(len(files)), files):\n\n    true_values = xr.open_dataset(f, decode_times=False).Sigma0_20Hz.values.flatten()\n    \n    # check that all values are the same\n    assert np.isclose(\n        true_values, \n        ds.sel(trajectory=i).Sigma0_20Hz.values.flatten()[:true_values.shape[0]], \n        equal_nan=True\n    ).all()\n    \n    # check that all padding is NA\n    assert np.isnan(ds.sel(trajectory=i).Sigma0_20Hz.values.flatten()[true_values.shape[0]:]).all()","key":"nZM3LSa2oG"},{"type":"output","id":"sqGqiCKT5BMzQaZbgi6HD","data":[],"key":"fDvZhFU7dj"}],"key":"qzIdx1Q4cy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"","key":"buN29E95mu"},{"type":"output","id":"Xy1_7mpEQEOpIrDeiyeHi","data":[],"key":"rdEqWu8EDt"}],"key":"zGaDW2rLxx"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2. Generate STAC collection for the new files","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xSCoyvkQHI"}],"identifier":"id-2-generate-stac-collection-for-the-new-files","label":"2. Generate STAC collection for the new files","html_id":"id-2-generate-stac-collection-for-the-new-files","implicit":true,"key":"k6ItHqYclY"}],"key":"IoH1xKiQl6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from pystac import Collection\nimport pystac\nimport xarray as xr\nimport shapely\nimport json\nfrom datetime import datetime\nfrom xstac import xarray_to_stac\nfrom xstac._xstac import build_horizontal_dimension\n\n# define collection id, since it will be reused\ncollectionid = \"waposal\"\n\n# create the root collection using pystac.Collection\n\ncollection = Collection.from_dict(\n    \n{\n  \"type\": \"Collection\",\n  \"id\": \"waposal\",\n  \"stac_version\": \"1.1.0\",\n  \"description\": \"Wave power density, zero-crossing wave period, and significant wave height product obtained along track based on Sentinel-3 A/B and Cryosat-2 altimeter data processed by SAMOSA+ retracker. The products cover the Atlantic coast of Europe, Madeira, the French Polynesian archipelagos, the Azores, the Canary Islands, the Mediterranean and Baltic Seas, and the coastal zone of French Guiana.\",\n  \"links\": [],\n  \"stac_extensions\": [\n    \"https://stac-extensions.github.io/osc/v1.0.0/schema.json\",\n    \"https://stac-extensions.github.io/themes/v1.0.0/schema.json\",\n    \"https://stac-extensions.github.io/cf/v0.2.0/schema.json\"\n  ],\n  \"osc:project\": \"waposal\",\n  \"osc:status\": \"completed\",\n  \"osc:region\": \"severeal\",\n  \"osc:type\": \"product\",\n  \"created\": \"2025-10-29T11:40:41Z\",\n  \"updated\": \"2025-10-29T11:40:41Z\",\n  \"sci:doi\": \"https://doi.org/10.57780/s3d-83ad619\",\n  \"cf:parameter\": [\n    {\n      \"name\": \"wave-period\"\n    },\n    {\n      \"name\": \"wave-height\"\n    }\n  ],\n  \"themes\": [\n    {\n      \"scheme\": \"https://github.com/stac-extensions/osc#theme\",\n      \"concepts\": [\n        {\n          \"id\": \"oceans\"\n        }\n      ]\n    }\n  ],\n  \"osc:missions\": [\n    \"sentinel-3\",\n    \"cryosat-2\"\n  ],\n  \"osc:variables\": [\n    \"wave-period\",\n    \"wave-height\"\n  ],\n  \"title\": \"High-resolution WAPOSAL wave period and wave power density from Sentinel-3 A/B, CryoSat-2, and SAMOSA+ retracker\",\n  \"extent\": {\n    \"spatial\": {\n      \"bbox\": [\n        [\n          -155,\n          -27,\n          41.8,\n          72\n        ],\n        [\n          -32,\n          36.499999999999986,\n          -24,\n          40\n        ],\n        [\n          -10,\n          42.00000000000003,\n          -1,\n          45\n        ],\n        [\n          -10,\n          43,\n          -0.5,\n          49\n        ],\n        [\n          3,\n          53,\n          30.35,\n          72\n        ],\n        [\n          -11,\n          47.5,\n          10,\n          60.00000000000003\n        ],\n        [\n          -155,\n          -27,\n          -134,\n          -6.999999999999986\n        ],\n        [\n          -54,\n          4.1000000000000085,\n          -51.5,\n          6\n        ],\n        [\n          -19,\n          26,\n          -10,\n          31\n        ],\n        [\n          -6,\n          30.09999999999998,\n          41.79999999999999,\n          47.400000000000006\n        ],\n        [\n          -19,\n          27,\n          -5,\n          39\n        ],\n        [\n          -13.000000000000002,\n          34,\n          -5.5,\n          44.5\n        ]\n      ]\n    },\n    \"temporal\": {\n      \"interval\": [\n        [\n          \"2011-01-01T00:00:00Z\",\n          \"2023-12-31T23:59:59Z\"\n        ]\n      ]\n    }\n  },\n  \"license\": \"CC-BY-SA-4.0\",\n  \"keywords\": [\n    \"altimeter data\",\n    \"wave energy\",\n    \"wave power\",\n    \"wave frequency\",\n    \"wave\"\n  ]\n}\n\n)\n\ncollection","key":"UiNow2lmRs"},{"type":"output","id":"bJjX9cTm6CRTCHMFZwj6l","data":[{"output_type":"execute_result","execution_count":1,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"2f9c1ea9b6aef404496f3aa716056fbd","path":"/tutorials/build/2f9c1ea9b6aef404496f3aa716056fbd.html"},"text/plain":{"content":"<Collection id=waposal>","content_type":"text/plain"}}}],"key":"SklkcKBtGD"}],"key":"SIj8EafkP8"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"files = sorted(Path(f'./combined').glob(\"*.zarr\"))\n\nfor f in files:\n    ds = xr.open_zarr(f,decode_times=False)\n\n    # Describe the first file following the datacube stac extension standards.\n    # All data is extracted from the metadata / data already present in the file we only specify\n    # the template and what information is extracted\n\n    bbox = [ds.attrs['min_lon'], ds.attrs['min_lat'], ds.attrs['max_lon'],ds.attrs['max_lat']]\n    geometry = json.loads(json.dumps(shapely.box(*bbox).__geo_interface__))\n    \n    template = {\n    \n        \"id\": f\"{collectionid}-{f.stem.lower()}\",\n        \"type\": \"Feature\",\n        \"stac_version\": \"1.1.0\",\n        \"description\": ds.attrs['description'],\n        \"title\": f.stem,\n        \"properties\": {\n                \"feature_type\" : \"trajectory\",\n                \"start_datetime\": ds.attrs['start_datetime'] + \"Z\", \n                \"end_datetime\": ds.attrs['end_datetime'] + \"Z\",\n                \"zone\" : ds.attrs['zone'],\n                \"platform_name\" :  ds.attrs['platform_name'],\n                \"institution\" :  ds.attrs['institution'],\n                \"license\" :  ds.attrs['license'],\n                \"reference\": ds.attrs['referencfe']\n        },\n        \"geometry\": geometry,\n        \"bbox\": bbox,\n        \"assets\": {\n            \"data\": {\n                \"href\": f\"https://s3.waw4-1.cloudferro.com/EarthCODE/OSCAssets/waposal/{f.stem}.zarr\",  # or local path\n                \"type\": \"application/vnd+zarr\",\n                \"roles\": [\"data\"],\n                \"title\": f.stem\n            }\n        }\n    }\n    \n    # 3. Generate the STAC Item\n    item = xarray_to_stac(\n        ds,\n        template,\n        temporal_dimension=False,\n        x_dimension=False,\n        y_dimension=False,  \n\n        reference_system=False\n    )\n\n    # add the multiple dimensions\n    dims = item.properties['cube:dimensions']\n    for d in list(ds.dims):\n        r = build_horizontal_dimension(ds, d, None, None, None, None, False).to_dict()\n        r['type'] = \"trajectory\" if d == 'trajectory' else \"observation\"\n        for k, v in r.copy().items():\n            if v is None:\n                del r[k]\n        dims[d] = r\n\n    item.validate()\n\n    collection.add_item(item)\n\ncollection.normalize_and_save(\n    root_href=f'./{collectionid}',\n    catalog_type=pystac.CatalogType.SELF_CONTAINED\n)","key":"JtF6Re3Mdo"},{"type":"output","id":"lVJ9p0HA3At27YYX2_6g1","data":[],"key":"aEcvWMATkE"}],"key":"RCquMq22sf"}],"key":"gD7QL1vAIQ"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Sen4Amazonas: Time-Series Forest Loss Zarr Cube","url":"/sen4amazonas","group":"EarthCODE Tutorials"},"next":{"title":"ESA Project Results Repository (PRR) Data Access and Collections Preview","url":"/prr-stac-download-example","group":"EarthCODE Tutorials"}}},"domain":"http://localhost:3000"}